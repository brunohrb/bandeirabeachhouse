<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bandeira Stay Manager</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>:root{--primary-color:#2d7a7a;--primary-dark:#1a4d4d;--accent-color:#d4a574;--text-dark:#333;--text-light:#666;--bg-light:#f5f5f5;--bg-white:#fff;--border-color:#e0e0e0;--red:#dc3545;--green:#28a745}*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:var(--bg-light);color:var(--text-dark)}.container{display:flex;min-height:100vh}.sidebar{width:260px;background:linear-gradient(180deg,var(--primary-color) 0%,var(--primary-dark) 100%);color:white;padding:24px 0;position:fixed;height:100vh;overflow-y:auto;z-index:100}.logo{display:flex;align-items:center;gap:12px;padding:0 24px 24px;border-bottom:1px solid rgba(255,255,255,.1);margin-bottom:24px}.menu-item{padding:12px 24px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:12px;font-size:14px}.menu-item:hover{background:rgba(255,255,255,.1)}.menu-item.active{background:rgba(255,255,255,.15);border-left:3px solid var(--accent-color)}.main{margin-left:260px;flex:1;padding:32px;width:calc(100% - 260px)}.page{display:none}.page.active{display:block}.page-header{margin-bottom:24px;display:flex;justify-content:space-between;align-items:center}.page-header h2{font-size:28px;color:var(--primary-dark);font-weight:700}.card{background:var(--bg-white);border-radius:12px;padding:24px;box-shadow:0 4px 12px rgba(0,0,0,.08);margin-bottom:24px}.btn{padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:8px}.btn-primary{background:var(--primary-dark);color:white}.btn-primary:hover{background:var(--primary-color)}.btn-secondary{background:var(--accent-color);color:white}.btn-link{background:none;color:var(--text-light);font-weight:500}.upload-area{border:2px dashed var(--primary-color);border-radius:12px;padding:48px;text-align:center;cursor:pointer}.form-group{margin-bottom:20px}.form-label{display:block;margin-bottom:8px;font-size:14px;font-weight:500}.form-input,.form-select{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-size:14px}.flex{display:flex}.gap-16{gap:16px}.flex-1{flex:1}.filter-bar{display:flex;flex-wrap:wrap;gap:16px;align-items:center}.select2-container{width:100%!important}.select2-container .select2-selection--multiple{border:1px solid var(--border-color)!important;padding:6px!important;border-radius:8px!important;min-height:48px}.indicadores-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:24px}.indicador-card{background:var(--bg-white);border-radius:10px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.05)}.indicador-card.clickable{cursor:pointer;transition:transform .2s,box-shadow .2s}.indicador-card.clickable:hover{transform:translateY(-3px);box-shadow:0 6px 12px rgba(0,0,0,.08)}.indicador-label{font-size:13px;color:var(--text-light);margin-bottom:4px;text-transform:uppercase;font-weight:600}.indicador-valor{font-size:26px;font-weight:700;color:var(--primary-dark)}.indicador-valor.red{color:var(--red)}.indicador-valor.green{color:var(--green)}.indicador-chart{height:200px;margin-top:16px}.table-container{overflow-x:auto}table{width:100%;border-collapse:collapse;font-size:14px}th,td{padding:12px 15px;text-align:left;border-bottom:1px solid var(--border-color)}th{background-color:#f8f9fa;font-weight:600;text-transform:uppercase;font-size:12px}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:1000}.modal-overlay.active{display:flex}.modal-content{background:var(--bg-white);padding:32px;border-radius:12px;width:90%;max-width:500px}.unidade-grupo{border-top:3px solid var(--primary-dark);margin-top:16px;padding-top:0}.unidade-header{background:rgba(45,122,122,0.08);padding:12px 16px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;transition:background 0.2s;border-radius:8px 8px 0 0}.unidade-header:hover{background:rgba(45,122,122,0.12)}.unidade-nome{font-weight:700;color:var(--primary-dark);font-size:15px;display:flex;align-items:center;gap:10px}.unidade-toggle{font-size:18px;transition:transform 0.2s}.unidade-toggle.collapsed{transform:rotate(-90deg)}.unidade-conteudo{display:block}.unidade-conteudo.collapsed{display:none}.unidade-conteudo table{margin-top:0;border-radius:0 0 8px 8px}.filter-ano-pequeno{display:flex;gap:8px;align-items:center;margin-bottom:16px}.filter-ano-pequeno select{width:150px;padding:8px;border:1px solid var(--border-color);border-radius:6px;font-size:13px}.analitica-filtros{display:flex;gap:16px;align-items:center;margin-bottom:24px;flex-wrap:wrap}.analitica-filtros select{padding:10px 12px;border:1px solid var(--border-color);border-radius:6px;font-size:14px}.analitica-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:24px}.analitica-card{background:var(--bg-white);border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,.05)}.analitica-card-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}.analitica-card-icon{font-size:32px}.analitica-card-title{font-size:14px;color:var(--text-light);text-transform:uppercase;font-weight:600}.analitica-card-value{font-size:28px;font-weight:700;color:var(--primary-dark);margin-top:8px}.analitica-card-value.green{color:var(--green)}.analitica-card-value.red{color:var(--red)}.analitica-card-chart{height:150px;margin-top:16px}</style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo"><div class="logo-text"><h1>Bandeira Stay</h1><p>Manager</p></div></div>
            <div class="menu-item active" onclick="showPage('financeiro', this)">ðŸ’° Financeiro</div>
            <div class="menu-item" onclick="showPage('analitica', this)">ðŸ“Š AnalÃ­tica</div>
            <div class="menu-item" onclick="showPage('despesas', this)">ðŸ’¸ Despesas</div>
            <div class="menu-item" onclick="showPage('reservas', this)">ðŸ§¹ Reservas Futuras</div>
            <div class="menu-item" onclick="showPage('proprietarios', this)">ðŸ‘¤ ProprietÃ¡rios</div>
            <div class="menu-item" onclick="showPage('upload', this)">ðŸ“¤ Upload de Dados</div>
        </div>
        <div class="main">
            <div id="financeiro" class="page">
                <div class="page-header"><h2>Financeiro</h2><button class="btn btn-link" onclick="zerarFinanceiro()">/ Zerar tudo</button></div>
                <div class="card filter-bar">
                    <div class="form-group flex-1"><select id="filtroAnos" class="form-select" multiple="multiple"></select></div>
                    <div class="form-group flex-1"><select id="filtroMeses" class="form-select" multiple="multiple"></select></div>
                    <div class="form-group flex-1"><select id="filtroUnidades" class="form-select" multiple="multiple"></select></div>
                    <button class="btn btn-primary" onclick="renderViews()">Aplicar</button>
                </div>
                <div class="flex gap-16" style="margin-bottom: 24px;">
<button class="btn btn-primary" id="btn-view-cards" onclick="setViewMode('cards')">ðŸ“Š Cards</button>
    <button class="btn btn-secondary" id="btn-view-lista" onclick="setViewMode('lista')">ðŸ“„ Lista</button>

    <!-- ðŸ”„ BOTÃƒO NOVO -->
<button onclick="atualizarDoSmoobuViaDownload()">
  ðŸ”„ Atualizar do Smoobu
</button>


                </div>
                <div id="view-cards"><div id="indicadores-gerais" class="indicadores-grid"></div></div>
                <div id="view-lista" style="display: none;">
                    <div class="filter-ano-pequeno">
                        <label style="font-weight:600;margin:0;">Filtrar por Ano:</label>
                        <select id="filtroAnoLista" onchange="renderViews()" style="width:150px;padding:8px;border:1px solid var(--border-color);border-radius:6px;">
                            <option value="">Todos os anos</option>
                        </select>
                    </div>
                    <div id="indicadores-lista" class="indicadores-grid"></div>
                    <div class="card"><div id="tabela-lista-financeira"></div></div>
                </div>
            </div>
            <div id="analitica" class="page">
                <div class="page-header"><h2>AnalÃ­tica</h2></div>
                <div class="card filter-bar">
                    <div class="form-group flex-1"><select id="filtroAnaliticaAnos" class="form-select" multiple="multiple"></select></div>
                    <div class="form-group flex-1"><select id="filtroAnaliticaMeses" class="form-select" multiple="multiple"></select></div>
                    <div class="form-group flex-1"><select id="filtroAnaliticaUnidades" class="form-select" multiple="multiple"></select></div>
                    <button class="btn btn-primary" onclick="renderAnalitica()">Aplicar</button>
                </div>
                <div class="analitica-cards">
                    <div class="analitica-card">
                        <div class="analitica-card-header">
                            <div class="analitica-card-icon">ðŸ’°</div>
                            <div class="analitica-card-title">Receita</div>
                        </div>
                        <div class="analitica-card-value green" id="analitica-receita">R$ 0,00</div>
                        <div class="analitica-card-chart"><canvas id="chart-receita"></canvas></div>
                    </div>
                    <div class="analitica-card">
                        <div class="analitica-card-header">
                            <div class="analitica-card-icon">ðŸ“¦</div>
                            <div class="analitica-card-title">Reservas</div>
                        </div>
                        <div class="analitica-card-value" id="analitica-reservas">0</div>
                        <div class="analitica-card-chart"><canvas id="chart-reservas"></canvas></div>
                    </div>
                    <div class="analitica-card">
                        <div class="analitica-card-header">
                            <div class="analitica-card-icon">ðŸ’³</div>
                            <div class="analitica-card-title">ComissÃ£o</div>
                        </div>
                        <div class="analitica-card-value red" id="analitica-comissao">-R$ 0,00</div>
                        <div class="analitica-card-chart"><canvas id="chart-comissao-card"></canvas></div>
                    </div>
                    <div class="analitica-card">
                        <div class="analitica-card-header">
                            <div class="analitica-card-icon">ðŸ’¸</div>
                            <div class="analitica-card-title">Despesas</div>
                        </div>
                        <div class="analitica-card-value red" id="analitica-despesas">-R$ 0,00</div>
                        <div class="analitica-card-chart"><canvas id="chart-despesas-card"></canvas></div>
                    </div>
                    <div class="analitica-card">
                        <div class="analitica-card-header">
                            <div class="analitica-card-icon">ðŸ“ˆ</div>
                            <div class="analitica-card-title">Lucro LÃ­quido</div>
                        </div>
                        <div class="analitica-card-value green" id="analitica-lucro">R$ 0,00</div>
                        <div class="analitica-card-chart"><canvas id="chart-lucro"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom:20px;">Receita por Unidade</h3>
                    <div style="height:300px;"><canvas id="chart-receita-unidade"></canvas></div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom:20px;">ComissÃ£o Portais por Unidade</h3>
                    <div style="height:300px;"><canvas id="chart-comissao"></canvas></div>
                </div>
            </div>
            <div id="despesas" class="page">
                <div class="page-header"><h2>Detalhes das Despesas</h2><button class="btn btn-primary" onclick="openDespesaModal()">+ Nova Despesa</button></div>
                <div class="card"><div class="table-container"><table id="tabela-despesas-detalhada"></table></div></div>
            </div>
            <div id="reservas" class="page">
                <div class="page-header"><h2>Gerador de Mensagem para Limpeza</h2></div>
                <div class="card"><div class="upload-area" onclick="document.getElementById('reservasFileInput').click()"><input type="file" id="reservasFileInput" accept=".xlsx,.xls" onchange="processarReservasFuturas(this.files[0])"><div style="font-size: 48px; margin-bottom: 16px;">ðŸ“…</div><h3>Selecione o arquivo de reservas futuras</h3></div></div>
                <div id="reservasPreview" style="display:none;"><div class="card"><div class="form-group"><label class="form-label">NÃºmero WhatsApp (com DDD)</label><input type="tel" id="whatsappLimpeza" class="form-input" placeholder="5585999999999"></div></div><div class="card"><h3>Preview da Mensagem</h3><pre id="mensagemPreview" style="background: #f5f5f5; padding: 20px; border-radius: 8px;"></pre><button class="btn btn-primary" style="margin-top: 16px;" onclick="enviarWhatsApp()">ðŸ“± Enviar via WhatsApp</button></div></div>
            </div>
            <div id="proprietarios" class="page">
                <div class="page-header"><h2>GestÃ£o de ProprietÃ¡rios</h2></div>
                <div class="card"><div id="proprietarios-list"></div><button class="btn btn-primary" style="margin-top: 16px;" onclick="salvarProprietarios()">Salvar AlteraÃ§Ãµes</button></div>
            </div>
            <div id="upload" class="page">
                <div class="page-header"><h2>Upload de Arquivo Smoobu</h2></div>
                <div class="card"><div class="upload-area">
<input type="file" id="fileInput" accept=".xlsx,.xls" onchange="processarEAdicionarDados(this.files[0])">


<div style="font-size: 48px; margin-bottom: 16px;">ðŸ“„</div><h3>Selecione o arquivo de RESERVAS</h3><p>A receita serÃ¡ contabilizada pela data de PARTIDA.</p></div></div>
            </div>
        </div>
    </div>
    <div id="despesaModal" class="modal-overlay">
        <div class="modal-content">
            <div class="page-header"><h3>Adicionar Nova Despesa</h3><button style="background:none; border:none; font-size: 24px; cursor:pointer;" onclick="closeDespesaModal()">&times;</button></div>
            <div class="form-group"><label class="form-label">Unidade</label><select id="despesaUnidade" class="form-select"></select></div>
            <div class="form-group"><label class="form-label">DescriÃ§Ã£o</label><input type="text" id="despesaDescricao" class="form-input"></div>
            <div class="form-group"><label class="form-label">Categoria</label><input type="text" id="despesaCategoria" class="form-input"></div>
            <div class="form-group"><label class="form-label">Data</label><input type="date" id="despesaData" class="form-input"></div>
            <div class="form-group"><label class="form-label">Valor</label><input type="number" id="despesaValor" class="form-input"></div>
            <button class="btn btn-primary" style="width: 100%;" onclick="salvarDespesa()">Salvar Despesa</button>
        </div>
    </div>

<script>
/* ===========================
   BANCO LOCAL (OBRIGATÃ“RIO)
=========================== */

const DB_RESERVAS = "DB_RESERVAS";
const DB_DESPESAS = "DB_DESPESAS";
const DB_PROPRIETARIOS = "DB_PROPRIETARIOS";

function getDb(key) {
    try {
        return JSON.parse(localStorage.getItem(key)) || [];
    } catch (e) {
        console.error("Erro ao ler DB:", key, e);
        return [];
    }
}

function saveDb(key, data) {
    localStorage.setItem(key, JSON.stringify(data));
}

function formatCurrency(valor) {
    return (valor || 0).toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL"
    });
}

/* ===========================
   CONTROLES GLOBAIS
=========================== */
let currentViewMode = "cards";
let chartsAnalitica = {};



        function showPage(e,a){
            document.querySelectorAll(".page").forEach(e=>e.classList.remove("active")),
            document.querySelectorAll(".menu-item").forEach(e=>e.classList.remove("active")),
            document.getElementById(e).classList.add("active"),
            a&&a.classList.add("active"),
        "analitica"===e&&(setupAnaliticaFilters(),renderAnalitica()),
            "despesas"===e&&renderTabelaDespesasDetalhada(),
            "proprietarios"===e&&renderProprietarios()
        }

        function setViewMode(e){
            currentViewMode=e,
            document.getElementById("view-cards").style.display="cards"===e?"block":"none",
            document.getElementById("view-lista").style.display="lista"===e?"block":"none",
            document.getElementById("btn-view-cards").classList.toggle("btn-primary","cards"===e),
            document.getElementById("btn-view-cards").classList.toggle("btn-secondary","cards"!==e),
            document.getElementById("btn-view-lista").classList.toggle("btn-primary","lista"===e),
            document.getElementById("btn-view-lista").classList.toggle("btn-secondary","lista"!==e),
            renderViews()
        }
        
     function processarEAdicionarDados(e){
    if (!e) return;

    const reader = new FileReader();

    reader.onload = function (evt) {
        try {
            const workbook = XLSX.read(
                new Uint8Array(evt.target.result),
                { type: "array" }
            );

            const sheet = workbook.Sheets[workbook.SheetNames[0]];

           const dados = XLSX.utils.sheet_to_json(sheet)
    .map(linha => {

        // ðŸ”‘ ID ÃšNICO DA RESERVA (Smoobu)
        const idReserva = linha["PosiÃ§Ã£o"];
        if (!idReserva) return null;

// ðŸ“… usa CHEGADA (REGRA CORRETA)
const data = parseDataBR(linha.Chegada || linha["Check-in"]);
if (!data) return null;

        // ðŸ’° SÃ“ CONTA SE TIVER PREÃ‡O
        const preco = parseFloat(linha.PreÃ§o || linha.Price || 0);
        if (!preco || preco <= 0) return null;

        // ðŸ§¾ COMISSÃƒO (pode ser zero)
        const comissao = parseFloat(linha["ComissÃ£o incluÃ­da"] || 0);

        return {
            idReserva: String(idReserva).trim(), // ðŸ‘ˆ ESSENCIAL
            unidade: (linha.Alojamento || linha.Accommodation || "N/A").trim(),
            ano: data.ano,
            mes: data.mes,
            mesAno: data.mesAno,
            receita: preco,
            comissao: comissao
        };
    })
    .filter(Boolean);



            if (dados.length === 0) {
                alert("âš ï¸ Nenhuma reserva vÃ¡lida encontrada.");
                return;
            }

        const banco = getDb(DB_RESERVAS);

// ðŸ”’ cria um set com IDs jÃ¡ existentes
const idsExistentes = new Set(
    banco.map(r => r.idReserva)
);

// ðŸ”Ž sÃ³ entram reservas novas
const novos = dados.filter(r => !idsExistentes.has(r.idReserva));

if (novos.length === 0) {
    alert("â„¹ï¸ Nenhuma reserva nova encontrada (duplicadas ignoradas)");
    return;
}

banco.push(...novos);
saveDb(DB_RESERVAS, banco);

alert(`âœ… ${novos.length} reservas novas importadas`);


            setupFilters();
            renderViews();

        } catch (err) {
            console.error(err);
            alert("âŒ Erro ao processar arquivo");
        }
    };

    reader.readAsArrayBuffer(e);
}

        
       function setupFilters() {
    const dados = getDb(DB_RESERVAS);
    if (dados.length === 0) return;

    // ðŸ“† ANOS (YYYY)
    const anos = [...new Set(
        dados.map(e => e.mesAno.substring(0, 4))
    )].sort();

    // ðŸ“… MESES (MM)
    const meses = [...new Set(
        dados.map(e => e.mesAno.substring(5, 7))
    )].sort();

    // ðŸ¢ UNIDADES
    const unidades = [...new Set(
        dados.map(e => e.unidade)
    )].sort();

    const selAno = document.getElementById("filtroAnos");
    const selMes = document.getElementById("filtroMeses");
    const selUn = document.getElementById("filtroUnidades");

    // ðŸ”¹ ANOS
    selAno.innerHTML = anos
        .map(a => `<option value="${a}">${a}</option>`)
        .join("");

    // ðŸ”¹ MESES (com nome)
    const nomesMeses = {
        "01": "Janeiro",
        "02": "Fevereiro",
        "03": "MarÃ§o",
        "04": "Abril",
        "05": "Maio",
        "06": "Junho",
        "07": "Julho",
        "08": "Agosto",
        "09": "Setembro",
        "10": "Outubro",
        "11": "Novembro",
        "12": "Dezembro"
    };

    selMes.innerHTML = meses
        .map(m => `<option value="${m}">${nomesMeses[m]}</option>`)
        .join("");

    // ðŸ”¹ UNIDADES
    selUn.innerHTML = unidades
        .map(u => `<option value="${u}">${u}</option>`)
        .join("");

    // ðŸ”„ Atualiza Select2
    $("#filtroAnos").trigger("change");
    $("#filtroMeses").trigger("change");
    $("#filtroUnidades").trigger("change");
}


        
        function setupAnaliticaFilters(){
            const e=getDb(DB_RESERVAS),
                  a=[...new Set(e.map(e=>e.unidade))].sort(),
                  t=[...new Set(e.map(e=>e.mesAno.substring(0,4)))].sort(),
                  s=["Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"].map((e,a)=>({id:String(a+1).padStart(2,"0"),text:e}));
            $("#filtroAnaliticaUnidades").empty().select2({data:a,placeholder:"Todos os alojamentos"}),
            $("#filtroAnaliticaAnos").empty().select2({data:t,placeholder:"Todos os anos"}),
            $("#filtroAnaliticaMeses").empty().select2({data:s,placeholder:"Todos os meses"})
        }
        
        function renderAnalitica(){
            try{
                let anosVal=$("#filtroAnaliticaAnos").val();
                let mesesVal=$("#filtroAnaliticaMeses").val();
                let unidadesVal=$("#filtroAnaliticaUnidades").val();
                
                const anos=Array.isArray(anosVal)?anosVal:(anosVal?[anosVal]:[]);
                const meses=Array.isArray(mesesVal)?mesesVal:(mesesVal?[mesesVal]:[]);
                const unidades=Array.isArray(unidadesVal)?unidadesVal:(unidadesVal?[unidadesVal]:[]);
                
                const passaNosFiltros=(registro,campoData)=>{
                    const ano=registro[campoData].substring(0,4);
                    const mes=registro[campoData].substring(5,7);
                    const unidade=registro.unidade;
                    
                    const passaAno=(anos.length===0||anos.includes(ano));
                    const passaMes=(meses.length===0||meses.includes(mes));
                    const passaUnidade=(unidades.length===0||unidades.includes(unidade));
                    
                    return passaAno&&passaMes&&passaUnidade;
                };
                
                const reservas=getDb(DB_RESERVAS).filter(e=>passaNosFiltros(e,"mesAno"));
                const despesas=getDb(DB_DESPESAS).filter(e=>passaNosFiltros(e,"data"));
                
                const receita=reservas.reduce((acc,e)=>acc+e.receita,0);
                const comissao=reservas.reduce((acc,e)=>acc+e.comissao,0);
                const despesasTotal=despesas.reduce((acc,e)=>acc+e.valor,0);
                const lucro=receita-comissao-despesasTotal;
                
                document.getElementById("analitica-receita").textContent=formatCurrency(receita);
                document.getElementById("analitica-receita").className="analitica-card-value green";
                document.getElementById("analitica-reservas").textContent=reservas.length;
                document.getElementById("analitica-comissao").textContent="-"+formatCurrency(comissao);
                document.getElementById("analitica-comissao").className="analitica-card-value red";
                document.getElementById("analitica-despesas").textContent="-"+formatCurrency(despesasTotal);
                document.getElementById("analitica-despesas").className="analitica-card-value red";
                document.getElementById("analitica-lucro").textContent=formatCurrency(lucro);
                document.getElementById("analitica-lucro").className=lucro>=0?"analitica-card-value green":"analitica-card-value red";
                
                renderAnaliticaCharts(reservas,despesas,anos,meses,unidades);
            }catch(err){
                console.error("Erro em renderAnalitica:",err);
            }
        }
        
        function renderAnaliticaCharts(reservas,despesas,anos,meses,unidades){
            Object.values(chartsAnalitica).forEach(chart=>{
                if(chart)chart.destroy();
            });
            chartsAnalitica={};
            
            const mesesLabels=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
            const receitaPorMes=mesesLabels.map((m,i)=>{
                const mesStr=String(i+1).padStart(2,"0");
                return reservas.filter(e=>e.mesAno.substring(5,7)===mesStr).reduce((acc,e)=>acc+e.receita,0);
            });
            
            const ctxReceita=document.getElementById("chart-receita").getContext("2d");
            chartsAnalitica.receita=new Chart(ctxReceita,{
                type:"line",
                data:{
                    labels:mesesLabels,
                    datasets:[{
                        label:"Receita",
                        data:receitaPorMes,
                        borderColor:"#28a745",
                        backgroundColor:"rgba(40,167,69,0.1)",
                        borderWidth:2,
                        fill:true,
                        tension:0.4
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
            });
            
            const ctxReservas=document.getElementById("chart-reservas").getContext("2d");
            chartsAnalitica.reservas=new Chart(ctxReservas,{
                type:"doughnut",
                data:{
                    labels:["Reservas","Canceladas"],
                    datasets:[{
                        data:[reservas.length,0],
                        backgroundColor:["#2d7a7a","#dc3545"],
                        borderColor:["#1a4d4d","#c82333"],
                        borderWidth:2
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:"bottom"}}}
            });
            
            const ctxComissaoCard=document.getElementById("chart-comissao-card").getContext("2d");
            chartsAnalitica.comissaoCard=new Chart(ctxComissaoCard,{
                type:"line",
                data:{
                    labels:mesesLabels,
                    datasets:[{
                        label:"ComissÃ£o",
                        data:mesesLabels.map((m,i)=>{
                            const mesStr=String(i+1).padStart(2,"0");
                            return reservas.filter(e=>e.mesAno.substring(5,7)===mesStr).reduce((acc,e)=>acc+e.comissao,0);
                        }),
                        borderColor:"#dc3545",
                        backgroundColor:"rgba(220,53,69,0.1)",
                        borderWidth:2,
                        fill:true,
                        tension:0.4
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
            });
            
            const ctxDespesasCard=document.getElementById("chart-despesas-card").getContext("2d");
            chartsAnalitica.despesasCard=new Chart(ctxDespesasCard,{
                type:"line",
                data:{
                    labels:mesesLabels,
                    datasets:[{
                        label:"Despesas",
                        data:mesesLabels.map((m,i)=>{
                            const mesStr=String(i+1).padStart(2,"0");
                            return despesas.filter(e=>e.data.substring(5,7)===mesStr).reduce((acc,e)=>acc+e.valor,0);
                        }),
                        borderColor:"#ffc107",
                        backgroundColor:"rgba(255,193,7,0.1)",
                        borderWidth:2,
                        fill:true,
                        tension:0.4
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
            });
            
            const ctxLucro=document.getElementById("chart-lucro").getContext("2d");
            chartsAnalitica.lucro=new Chart(ctxLucro,{
                type:"line",
                data:{
                    labels:mesesLabels,
                    datasets:[{
                        label:"Lucro",
                        data:mesesLabels.map((m,i)=>{
                            const mesStr=String(i+1).padStart(2,"0");
                            const rec=reservas.filter(e=>e.mesAno.substring(5,7)===mesStr).reduce((acc,e)=>acc+e.receita,0);
                            const com=reservas.filter(e=>e.mesAno.substring(5,7)===mesStr).reduce((acc,e)=>acc+e.comissao,0);
                            const des=despesas.filter(e=>e.data.substring(5,7)===mesStr).reduce((acc,e)=>acc+e.valor,0);
                            return rec-com-des;
                        }),
                        borderColor:"#28a745",
                        backgroundColor:"rgba(40,167,69,0.1)",
                        borderWidth:2,
                        fill:true,
                        tension:0.4
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
            });
            
            const unidadesUnicas=[...new Set(reservas.map(e=>e.unidade))];
            const receitaPorUnidade=unidadesUnicas.map(u=>reservas.filter(e=>e.unidade===u).reduce((acc,e)=>acc+e.receita,0));
            
            const ctxUnidade=document.getElementById("chart-receita-unidade").getContext("2d");
            chartsAnalitica.unidade=new Chart(ctxUnidade,{
                type:"bar",
                data:{
                    labels:unidadesUnicas,
                    datasets:[{
                        label:"Receita por Unidade",
                        data:receitaPorUnidade,
                        backgroundColor:"#2d7a7a",
                        borderColor:"#1a4d4d",
                        borderWidth:1
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
            });
            
            const comissaoPorUnidade=unidadesUnicas.map(u=>reservas.filter(e=>e.unidade===u).reduce((acc,e)=>acc+e.comissao,0));
            
            const ctxComissao=document.getElementById("chart-comissao").getContext("2d");
            chartsAnalitica.comissao=new Chart(ctxComissao,{
                type:"pie",
                data:{
                    labels:unidadesUnicas,
                    datasets:[{
                        data:comissaoPorUnidade,
                        backgroundColor:["#2d7a7a","#d4a574","#dc3545","#28a745","#ffc107","#17a2b8"],
                        borderColor:["#1a4d4d","#b8864f","#c82333","#1e7e34","#e0a800","#0c5460"],
                        borderWidth:2
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:"bottom"}}}
            });
        }
        
        function renderViews(){
            try{
                let anosVal=$("#filtroAnos").val();
                let mesesVal=$("#filtroMeses").val();
                let unidadesVal=$("#filtroUnidades").val();
                
                const anos=Array.isArray(anosVal)?anosVal:(anosVal?[anosVal]:[]);
                const meses=Array.isArray(mesesVal)?mesesVal:(mesesVal?[mesesVal]:[]);
                const unidades=Array.isArray(unidadesVal)?unidadesVal:(unidadesVal?[unidadesVal]:[]);
                
                let anosFinais=anos;
                if("lista"===currentViewMode){
                    const anoFiltro=document.getElementById("filtroAnoLista").value;
                    if(anoFiltro){
                        anosFinais=[anoFiltro];
                    }
                }
                
                const passaNosFiltros=(registro,campoData)=>{
                    const ano=registro[campoData].substring(0,4);
                    const mes=registro[campoData].substring(5,7);
                    const unidade=registro.unidade;
                    
                    const passaAno=(anosFinais.length===0||anosFinais.includes(ano));
                    const passaMes=(meses.length===0||meses.includes(mes));
                    const passaUnidade=(unidades.length===0||unidades.includes(unidade));
                    
                    return passaAno&&passaMes&&passaUnidade;
                };
                
                const reservas=getDb(DB_RESERVAS).filter(e=>passaNosFiltros(e,"mesAno"));
                const despesas=getDb(DB_DESPESAS).filter(e=>passaNosFiltros(e,"data"));
                
                if("cards"===currentViewMode){
                    renderCardsView(reservas,despesas);
                }else{
                    renderListaView(reservas,despesas,unidades,anosFinais,meses);
                }
            }catch(err){
                console.error("Erro em renderViews:",err);
                alert("Erro ao processar filtros: "+err.message);
            }
        }
        
        function renderCardsView(e,a){
            const t=e.reduce((e,a)=>e+a.receita,0),
                  s=e.reduce((e,a)=>e+a.comissao,0),
                  r=a.reduce((e,a)=>e+a.valor,0),
                  o=t-s-r;
            document.getElementById("indicadores-gerais").innerHTML=`
                <div class="indicador-card"><div class="indicador-label">Receita Total</div><div class="indicador-valor green">${formatCurrency(t)}</div></div>
                <div class="indicador-card"><div class="indicador-label">ComissÃ£o Portais</div><div class="indicador-valor red">-${formatCurrency(s)}</div></div>
                <div class="indicador-card"><div class="indicador-label">Total de Reservas</div><div class="indicador-valor">${e.length}</div></div>
                <div class="indicador-card clickable" onclick="showPage('despesas', document.querySelector('.menu-item[onclick*=\\'despesas\\']'))"><div class="indicador-label">Despesas</div><div class="indicador-valor red">-${formatCurrency(r)}</div></div>
                <div class="indicador-card"><div class="indicador-label">Lucro LÃ­quido</div><div class="indicador-valor green">${formatCurrency(o)}</div></div>
            `
        }
        
        function renderListaView(e,a,t,s,r){
            const o=document.getElementById("tabela-lista-financeira"),
                  n=t.length>0?t:[...new Set(getDb(DB_RESERVAS).map(e=>e.unidade))].sort(),
                  l=1===s.length?s[0]:(new Date).getFullYear().toString(),
                  d=r.length>0?r.sort():["01","02","03","04","05","06","07","08","09","10","11","12"],
                  i=["Receita Total","ComissÃ£o Portais","Despesas","Lucro"];
            
            const receitaTotal=e.reduce((acc,item)=>acc+item.receita,0),
                  comissaoTotal=e.reduce((acc,item)=>acc+item.comissao,0),
                  despesasTotal=a.reduce((acc,item)=>acc+item.valor,0),
                  lucroTotal=receitaTotal-comissaoTotal-despesasTotal;
            
            document.getElementById("indicadores-lista").innerHTML=`
                <div class="indicador-card"><div class="indicador-label">Receita Total</div><div class="indicador-valor green">${formatCurrency(receitaTotal)}</div></div>
                <div class="indicador-card"><div class="indicador-label">ComissÃ£o Portais</div><div class="indicador-valor red">-${formatCurrency(comissaoTotal)}</div></div>
                <div class="indicador-card"><div class="indicador-label">Despesas</div><div class="indicador-valor red">-${formatCurrency(despesasTotal)}</div></div>
                <div class="indicador-card"><div class="indicador-label">Lucro LÃ­quido</div><div class="indicador-valor green">${formatCurrency(lucroTotal)}</div></div>
            `;
            
            let c=``;
            n.forEach(t=>{
                c+=`<div class="unidade-grupo">
                    <div class="unidade-header" onclick="toggleUnidade('${t.replace(/\s+/g,'_')}')">
                        <div class="unidade-nome">
                            <span class="unidade-toggle" id="toggle_${t.replace(/\s+/g,'_')}">â–¼</span>
                            ${t}
                        </div>
                    </div>
                    <div class="unidade-conteudo" id="conteudo_${t.replace(/\s+/g,'_')}">
                        <table>
                            <thead><tr><th>Tipo</th>${d.map(e=>`<th>${e}/${l.substring(2)}</th>`).join("")}</tr></thead>
                            <tbody>`;
                i.forEach((s,r)=>{
                    c+=`<tr><td>${s}</td>`;
                    d.forEach(o=>{
                        const n=`${l}-${o}`,
                              u=e.filter(e=>e.unidade===t&&e.mesAno===n),
                              p=a.filter(e=>e.unidade===t&&e.data.startsWith(n)),
                              m=u.reduce((e,a)=>e+a.receita,0),
                              h=u.reduce((e,a)=>e+a.comissao,0),
                              v=p.reduce((e,a)=>e+a.valor,0);
                        let f=0;
                        if("Receita Total"===s)f=m;
                        else if("ComissÃ£o Portais"===s)f=-1*h;
                        else if("Despesas"===s)f=-1*v;
                        else if("Lucro"===s)f=m-h-v;
                        c+=`<td class="${f<0?"red":""}">${formatCurrency(f)}</td>`
                    });
                    c+=`</tr>`
                });
                c+=`</tbody></table></div></div>`
            });
            o.innerHTML=c
        }
        
        function toggleUnidade(unidadeId){
            const conteudo=document.getElementById(`conteudo_${unidadeId}`),
                  toggle=document.getElementById(`toggle_${unidadeId}`);
            conteudo.classList.toggle('collapsed'),
            toggle.classList.toggle('collapsed')
        }
        
        function renderTabelaDespesasDetalhada(){
            const e=getDb(DB_DESPESAS),a=document.getElementById("tabela-despesas-detalhada");
            let t="<thead><tr><th>DescriÃ§Ã£o</th><th>PrÃ©dio</th><th>Categoria</th><th>Data</th><th>Valor</th><th>AÃ§Ãµes</th></tr></thead><tbody>";
            e.length>0?e.sort((e,a)=>new Date(a.data)-new Date(e.data)).forEach(e=>{t+=`<tr><td>${e.descricao}</td><td>${e.unidade}</td><td>${e.categoria}</td><td>${(new Date(e.data)).toLocaleDateString("pt-BR",{timeZone:"UTC"})}</td><td>${formatCurrency(e.valor)}</td><td><button class="btn btn-link" style="color:var(--red);" onclick="excluirDespesa('${e.id}')">Excluir</button></td></tr>`}):t+='<tr><td colspan="6" style="text-align:center; padding: 20px;">Nenhuma despesa cadastrada.</td></tr>',a.innerHTML=t+"</tbody>"
        }
        
        function openDespesaModal(){
            document.getElementById("despesaModal").classList.add("active"),
            document.getElementById("despesaData").valueAsDate=new Date
        }
        
        function closeDespesaModal(){
            document.getElementById("despesaModal").classList.remove("active")
        }
        
        function salvarDespesa(){
            const e={id:`desp_${(new Date).getTime()}`,unidade:$("#despesaUnidade").val(),descricao:$("#despesaDescricao").val(),categoria:$("#despesaCategoria").val(),data:$("#despesaData").val(),valor:parseFloat($("#despesaValor").val())};
            if(!e.unidade||!e.descricao||!e.data||!e.valor)return void alert("âš ï¸ Preencha todos os campos!");
            const a=getDb(DB_DESPESAS);
            a.push(e),saveDb(DB_DESPESAS,a),alert("âœ… Despesa salva!"),closeDespesaModal(),renderTabelaDespesasDetalhada(),renderViews()
        }
        
        function excluirDespesa(e){
            if(!confirm("Tem certeza?"))return;
            saveDb(DB_DESPESAS,getDb(DB_DESPESAS).filter(a=>a.id!==e)),renderTabelaDespesasDetalhada(),renderViews()
        }
        
        function zerarFinanceiro(){
            confirm("ATENÃ‡ÃƒO! ApagarÃ¡ TUDO. Deseja continuar?")&&(localStorage.removeItem(DB_RESERVAS),localStorage.removeItem(DB_DESPESAS),localStorage.removeItem(DB_PROPRIETARIOS),alert("Todos os dados foram zerados."),showPage("financeiro",document.querySelector('.menu-item[onclick*="financeiro"]')))
        }
        
        function processarReservasFuturas(e){
            if(!e)return;
            const a=new FileReader;
            a.onload=function(t){
                try{
                    const e=XLSX.read(new Uint8Array(t.target.result),{type:"array",cellDates:!0}),s=XLSX.utils.sheet_to_json(e.Sheets[e.SheetNames[0]]),r={};
                    s.forEach(e=>{const a=e.Alojamento||e.Accommodation;a&&(r[a]||(r[a]=[]),r[a].push({hospede:e.HÃ³spede||e.Guest||"N/A",chegada:(new Date(e.Chegada||e["Check-in"])).toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"}),partida:(new Date(e.Partida||e["Check-out"])).toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"}),pessoas:parseInt(e.Adultos||0)+parseInt(e.CrianÃ§as||0)||1}))});
                    const o=Object.values(r)[0]?.[0];
                    if(!o)return void alert("Nenhuma reserva encontrada.");
                    const[,n]=o.chegada.split("/"),l=["JANEIRO","FEVEREIRO","MARÃ‡O","ABRIL","MAIO","JUNHO","JULHO","AGOSTO","SETEMBRO","OUTUBRO","NOVEMBRO","DEZEMBRO"][parseInt(n)-1];
                    let d=`ðŸŸ¦ ${l} ${(new Date).getFullYear()}\n\n`;
                    Object.keys(r).sort().forEach(e=>{d+=`ðŸ¢ ${e}\n\n`,r[e].forEach(e=>{d+=`${e.chegada} a ${e.partida} â€¢ ${e.hospede} â€¢ ${e.pessoas} pessoas\n`}),d+="\n"}),
                    document.getElementById("mensagemPreview").textContent=d,document.getElementById("reservasPreview").style.display="block"
                }catch(e){alert("âŒ Erro ao processar o arquivo: "+e.message)}
            },a.readAsArrayBuffer(e)
        }
        
        function enviarWhatsApp(){
            const e=document.getElementById("whatsappLimpeza").value;
            e?window.open(`https://wa.me/${e}?text=${encodeURIComponent(document.getElementById("mensagemPreview").textContent)}`,"_blank"):alert("âš ï¸ Digite o nÃºmero do WhatsApp!")
        }
        
        function renderProprietarios(){
            const e=getDb(DB_PROPRIETARIOS),a=[...new Set(getDb(DB_RESERVAS).map(e=>e.unidade))].sort();
            let t="";
            a.forEach(a=>{const s=e.find(e=>e.unidade===a)||{};t+=`<div class="card"><div class="form-group"><label class="form-label" style="font-weight: bold;">${a}</label><input type="text" class="form-input prop-input" data-unidade="${a}" value="${s.nome||""}" placeholder="Nome do proprietÃ¡rio"></div></div>`}),
            document.getElementById("proprietarios-list").innerHTML=t||"<p>Nenhuma unidade encontrada. Importe um arquivo de reservas primeiro.</p>"
        }
        
        function salvarProprietarios(){
            const e=document.querySelectorAll(".prop-input"),a=Array.from(e).map(e=>({unidade:e.dataset.unidade,nome:e.value.trim()})).filter(e=>e.nome);
            saveDb(DB_PROPRIETARIOS,a),alert("âœ… ProprietÃ¡rios salvos com sucesso!")
        }
        
        $(document).ready(function () {
$("#filtroAnos").select2({
    placeholder: "Filtrar por ano",
    allowClear: true
});

$("#filtroMeses").select2({
    placeholder: "Filtrar por mÃªs",
    allowClear: true
});

$("#filtroUnidades").select2({
    placeholder: "Filtrar por unidade",
    allowClear: true
});


    // ðŸ”§ inicializa filtros UMA ÃšNICA VEZ

    showPage("financeiro", document.querySelector('.menu-item[onclick*="financeiro"]'));
    setViewMode("cards");

// ðŸ‘‡ GATILHO AUTOMÃTICO (1 vez por sessÃ£o)
    // ðŸ”„ ATUALIZA AUTOMÃTICA â€” 1Âª vez do dia
    if (!jaAtualizouHoje()) {
        atualizarDoSmoobuViaDownload("auto");
    }
 
});
      
function getSmoobuCsvUrlAnoAtual() {
    const ano = new Date().getFullYear();

    return (
        "https://login.smoobu.com/api/v2/users/670124/bookings/exports/csv" +
        "?sort=-createdAt" +
        `&filter[arrivalDate][from]=${ano}-01-01` +
        `&filter[arrivalDate][to]=${ano}-12-31` +
        "&filter[includeIntersections]=true" +
        "&filter[excludeMockedBookings]=true" +
        "&filter[statuses][0]=1"
    );
}

function jaAtualizouHoje() {
    const hoje = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
    return localStorage.getItem("smoobuAtualizadoEm") === hoje;
}

function marcarAtualizadoHoje() {
    const hoje = new Date().toISOString().slice(0, 10);
    localStorage.setItem("smoobuAtualizadoEm", hoje);
}


function atualizarDoSmoobuViaDownload(motivo = "manual") {

    // 1ï¸âƒ£ Abre o Smoobu
    window.open(getSmoobuCsvUrlAnoAtual(), "_blank");

    // 2ï¸âƒ£ Se foi automÃ¡tico (primeira vez do dia), marca no sistema
    if (motivo === "auto") {
        marcarAtualizadoHoje();
    }

    // 3ï¸âƒ£ Leva para a tela de Upload
    showPage("upload", document.querySelector('.menu-item[onclick*="upload"]'));

    // 4ï¸âƒ£ Apenas destaca onde subir o arquivo
    setTimeout(() => {
        const input = document.getElementById("fileInput");
        if (input) {
            input.scrollIntoView({ behavior: "smooth", block: "center" });
        }
    }, 500);
}



function parseDataBR(valor) {
    if (!valor) return null;

    // ðŸŸ¢ Se vier como Date do Excel
    if (valor instanceof Date && !isNaN(valor)) {
        const ano = valor.getFullYear();
        const mes = String(valor.getMonth() + 1).padStart(2, "0");

        return {
            ano: String(ano),
            mes: mes,
            mesAno: `${ano}-${mes}`
        };
    }

    // ðŸŸ¡ Se vier como texto "dd/mm/aa" ou "dd/mm/aaaa"
    if (typeof valor === "string") {
        const partes = valor.split("/");
        if (partes.length !== 3) return null;

        let dia = partes[0];
        let mes = partes[1];
        let ano = partes[2];

        if (ano.length === 2) {
            ano = "20" + ano;
        }

        return {
            ano: ano,
            mes: mes.padStart(2, "0"),
            mesAno: `${ano}-${mes.padStart(2, "0")}`
        };
    }

    return null;
}
    </script>
</body>
</html>
