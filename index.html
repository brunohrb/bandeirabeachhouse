<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Bandeira Stay Manager - Integra√ß√£o Smoobu</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
* { 
  box-sizing: border-box; 
  margin: 0;
  padding: 0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
  background: #fafafa;
  color: #1a1a1a;
}

/* SIDEBAR */
.sidebar {
  position: fixed;
  left: 0;
  top: 0;
  width: 260px;
  height: 100vh;
  background: #ffffff;
  border-right: 1px solid #e5e5e5;
  display: flex;
  flex-direction: column;
  z-index: 100;
}

.logo-section {
  padding: 20px;
  border-bottom: 1px solid #e5e5e5;
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo-img {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, #4a9b8e 0%, #d4b896 100%);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
}

.logo-text h1 {
  font-size: 18px;
  font-weight: 700;
  color: #1a1a1a;
  line-height: 1.2;
}

.logo-text p {
  font-size: 12px;
  color: #666;
}

.menu {
  flex: 1;
  padding: 16px;
}

.menu a {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  color: #666;
  text-decoration: none;
  border-radius: 8px;
  cursor: pointer;
  margin-bottom: 4px;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
}

.menu a:hover {
  background: #f5f5f5;
  color: #1a1a1a;
}

.menu a.active {
  background: #4a9b8e;
  color: #ffffff;
}

.menu-icon {
  width: 20px;
  height: 20px;
}

/* MAIN */
.main {
  margin-left: 260px;
  padding: 32px;
  min-height: 100vh;
}

.hidden { 
  display: none !important; 
}

/* HEADER */
.page-header {
  margin-bottom: 32px;
}

.page-header h1 {
  font-size: 32px;
  font-weight: 700;
  color: #1a1a1a;
  margin-bottom: 8px;
}

.page-header p {
  font-size: 14px;
  color: #666;
}

/* TOPBAR */
.topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  gap: 16px;
  flex-wrap: wrap;
}

.topbar-left {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.btn {
  padding: 10px 20px;
  border-radius: 8px;
  border: none;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn-primary {
  background: #4a9b8e;
  color: #ffffff;
}

.btn-primary:hover {
  background: #3d8275;
}

.btn-secondary {
  background: #d4b896;
  color: #1a1a1a;
}

.btn-secondary:hover {
  background: #c4a886;
}

.btn-outline {
  background: transparent;
  border: 1px solid #e5e5e5;
  color: #1a1a1a;
}

.btn-outline:hover {
  background: #f5f5f5;
}

.btn-success {
  background: #10b981;
  color: #ffffff;
}

.btn-success:hover {
  background: #059669;
}

.month-input {
  padding: 10px 16px;
  border: 1px solid #e5e5e5;
  border-radius: 8px;
  font-size: 14px;
  color: #1a1a1a;
}

/* CARDS KPI */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}

.kpi-card {
  background: #ffffff;
  border: 1px solid #e5e5e5;
  border-radius: 12px;
  padding: 20px;
}

.kpi-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.kpi-title {
  font-size: 14px;
  font-weight: 500;
  color: #666;
}

.kpi-icon {
  width: 20px;
  height: 20px;
  color: #999;
}

.kpi-value {
  font-size: 28px;
  font-weight: 700;
  color: #1a1a1a;
}

.kpi-value.primary {
  color: #4a9b8e;
}

/* CARDS */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 20px;
  margin-top: 24px;
}

.card {
  background: #ffffff;
  border: 1px solid #e5e5e5;
  border-radius: 12px;
  padding: 24px;
  transition: all 0.2s;
}

.card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.card h3 { 
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 8px;
  color: #1a1a1a;
}

.owner {
  font-size: 13px;
  color: #666;
  margin-bottom: 16px;
}

.row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 14px;
}

.row span {
  color: #666;
}

.row b {
  color: #1a1a1a;
  font-weight: 600;
}

.row b.negative {
  color: #dc2626;
}

.extra {
  width: 100%;
  margin-top: 12px;
  padding: 10px;
  border: 1px solid #e5e5e5;
  border-radius: 6px;
  font-size: 14px;
}

.lucro {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid #e5e5e5;
  font-size: 20px;
  font-weight: 700;
  color: #4a9b8e;
}

/* MODAL */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal.show {
  display: flex;
}

.modal-content {
  background: #ffffff;
  padding: 32px;
  border-radius: 16px;
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-content h3 { 
  margin-top: 0;
  margin-bottom: 24px;
  font-size: 24px;
  font-weight: 700;
}

.modal-content label {
  display: block;
  margin-top: 16px;
  margin-bottom: 6px;
  font-weight: 600;
  font-size: 14px;
  color: #1a1a1a;
}

.modal-content input,
.modal-content select {
  width: 100%;
  padding: 10px 12px;
  margin-top: 4px;
  border: 1px solid #e5e5e5;
  border-radius: 8px;
  font-size: 14px;
}

.modal-footer {
  display: flex;
  gap: 12px;
  margin-top: 24px;
}

.modal-footer button {
  flex: 1;
}

/* CHARTS */
.chart-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 24px;
  margin-bottom: 32px;
}

.chart-card {
  background: #ffffff;
  border: 1px solid #e5e5e5;
  border-radius: 12px;
  padding: 24px;
}

.chart-card h3 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 20px;
  color: #1a1a1a;
}

.chart-container {
  position: relative;
  height: 300px;
}

/* EMPTY STATE */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #666;
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.empty-state h3 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 8px;
  color: #1a1a1a;
}

.empty-state p {
  font-size: 14px;
  color: #666;
  margin-bottom: 24px;
}

/* HIST√ìRICO */
.historico-card {
  background: #ffffff;
  border: 1px solid #e5e5e5;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 20px;
  transition: all 0.2s;
}

.historico-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.historico-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid #e5e5e5;
}

.historico-title {
  font-size: 24px;
  font-weight: 700;
  color: #1a1a1a;
}

.historico-date {
  font-size: 13px;
  color: #666;
}

.historico-kpis {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.historico-kpi {
  text-align: center;
  padding: 16px;
  background: #f9f9f9;
  border-radius: 8px;
}

.historico-kpi-label {
  font-size: 13px;
  color: #666;
  margin-bottom: 8px;
}

.historico-kpi-value {
  font-size: 20px;
  font-weight: 700;
  color: #1a1a1a;
}

.historico-kpi-value.primary {
  color: #4a9b8e;
}

.historico-units {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 16px;
}

.historico-unit {
  padding: 16px;
  background: #fafafa;
  border-radius: 8px;
  border: 1px solid #e5e5e5;
}

.historico-unit h4 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 12px;
  color: #1a1a1a;
}

.historico-unit .row {
  font-size: 13px;
  margin-bottom: 6px;
}

.historico-actions {
  display: flex;
  gap: 12px;
  margin-top: 16px;
}

/* STATUS BADGE */
.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
}

.status-connected {
  background: #d1fae5;
  color: #065f46;
}

.status-disconnected {
  background: #fee2e2;
  color: #991b1b;
}

/* LOADING */
.loading {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid #e5e5e5;
  border-top: 2px solid #4a9b8e;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* RESPONSIVE */
@media (max-width: 768px) {
  .sidebar {
    width: 100%;
    height: auto;
    position: relative;
  }
  
  .main {
    margin-left: 0;
    padding: 20px;
  }
  
  .kpi-grid,
  .cards,
  .chart-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="logo-section">
    <div class="logo-img">üèñÔ∏è</div>
    <div class="logo-text">
      <h1>Bandeira Stay</h1>
      <p>Manager</p>
    </div>
  </div>
  
  <div class="menu">
    <a class="active" onclick="showPage('dashboard', this)">
      <span class="menu-icon">üìä</span>
      Dashboard
    </a>
    <a onclick="showPage('despesas', this)">
      <span class="menu-icon">üí∏</span>
      Despesas Mensais
    </a>
    <a onclick="showPage('historico', this)">
      <span class="menu-icon">üìÖ</span>
      Hist√≥rico
    </a>
    <a onclick="showPage('indicadores', this)">
      <span class="menu-icon">üìà</span>
      Indicadores
    </a>
    <a onclick="showPage('smoobu', this)">
      <span class="menu-icon">üîå</span>
      Integra√ß√£o Smoobu
    </a>
    <a onclick="openUpload()">
      <span class="menu-icon">üìÑ</span>
      Upload Excel
    </a>
  </div>
</div>

<!-- MAIN -->
<div class="main">

  <!-- DASHBOARD -->
  <div id="dashboard">
    <div class="page-header">
      <h1>Dashboard</h1>
      <p>Vis√£o geral do desempenho mensal</p>
    </div>
    
    <div class="topbar">
      <div class="topbar-left">
        <input type="month" id="monthSelect" class="month-input">
        <span id="smoobuStatus" class="status-badge status-disconnected">
          ‚ö†Ô∏è Smoobu desconectado
        </span>
      </div>
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button class="btn btn-success" onclick="syncSmoobu()" id="btnSync">
          üîÑ Sincronizar Smoobu
        </button>
        <button class="btn btn-primary" onclick="openUpload()">
          üì§ Importar Excel
        </button>
        <button class="btn btn-secondary" onclick="saveMonth()">
          üíæ Salvar M√™s
        </button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-header">
          <span class="kpi-title">Receita Total</span>
          <span class="kpi-icon">üí∞</span>
        </div>
        <div class="kpi-value" id="kpiReceita">R$ 0,00</div>
      </div>
      
      <div class="kpi-card">
        <div class="kpi-header">
          <span class="kpi-title">Lucro L√≠quido</span>
          <span class="kpi-icon">üìà</span>
        </div>
        <div class="kpi-value primary" id="kpiLucro">R$ 0,00</div>
      </div>
      
      <div class="kpi-card">
        <div class="kpi-header">
          <span class="kpi-title">Total de Reservas</span>
          <span class="kpi-icon">üìÖ</span>
        </div>
        <div class="kpi-value" id="kpiReservas">0</div>
      </div>
      
      <div class="kpi-card">
        <div class="kpi-header">
          <span class="kpi-title">Unidades Ativas</span>
          <span class="kpi-icon">üè†</span>
        </div>
        <div class="kpi-value" id="kpiUnidades">0</div>
      </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="chart-grid">
      <div class="chart-card">
        <h3>Receita vs Lucro por Unidade</h3>
        <div class="chart-container">
          <canvas id="barChart"></canvas>
        </div>
      </div>
      
      <div class="chart-card">
        <h3>Distribui√ß√£o de Receita</h3>
        <div class="chart-container">
          <canvas id="pieChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Cards de Unidades -->
    <div class="card">
      <h3 style="margin-bottom: 16px;">Resultado por Unidade</h3>
      <div class="cards" id="cards"></div>
      <div id="emptyState" class="empty-state">
        <div class="empty-state-icon">üìä</div>
        <h3>Nenhum dado dispon√≠vel</h3>
        <p>Conecte sua conta Smoobu ou importe um arquivo Excel</p>
        <div style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;">
          <button class="btn btn-success" onclick="showPage('smoobu'); document.querySelectorAll('.menu a')[4].classList.add('active');">
            üîå Conectar Smoobu
          </button>
          <button class="btn btn-primary" onclick="openUpload()">üì§ Importar Excel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- INTEGRA√á√ÉO SMOOBU -->
  <div id="smoobu" class="hidden">
    <div class="page-header">
      <h1>Integra√ß√£o Smoobu</h1>
      <p>Configure a conex√£o autom√°tica com sua conta Smoobu</p>
    </div>

    <div class="card" style="margin-bottom: 24px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
          <h3 style="margin-bottom: 8px;">Status da Conex√£o</h3>
          <span id="smoobuStatusPage" class="status-badge status-disconnected">
            ‚ö†Ô∏è Desconectado
          </span>
        </div>
        <button class="btn btn-outline" onclick="disconnectSmoobu()" id="btnDisconnect" style="display: none;">
          üîå Desconectar
        </button>
      </div>

      <div id="smoobuConnect">
        <p style="margin-bottom: 20px; color: #666; line-height: 1.6;">
          Para conectar sua conta Smoobu, voc√™ precisa gerar uma API Key no painel administrativo do Smoobu.
        </p>

        <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
          <h4 style="margin-bottom: 12px; color: #0369a1;">üìù Como obter sua API Key:</h4>
          <ol style="margin-left: 20px; color: #0c4a6e; line-height: 1.8;">
            <li>Acesse <a href="https://login.smoobu.com" target="_blank" style="color: #0284c7; text-decoration: underline;">login.smoobu.com</a></li>
            <li>V√° em Configura√ß√µes ‚Üí API</li>
            <li>Clique em "Criar nova API Key"</li>
            <li>Copie a chave gerada</li>
            <li>Cole abaixo e clique em "Conectar"</li>
          </ol>
        </div>

        <label style="display: block; margin-bottom: 8px; font-weight: 600;">API Key do Smoobu</label>
        <div style="display: flex; gap: 12px;">
          <input type="password" id="smoobuApiKey" placeholder="Cole sua API Key aqui..." style="flex: 1; padding: 12px; border: 1px solid #e5e5e5; border-radius: 8px; font-size: 14px;">
          <button class="btn btn-primary" onclick="connectSmoobu()" style="padding: 12px 24px;">
            üîå Conectar
          </button>
        </div>
        <p style="margin-top: 8px; font-size: 13px; color: #666;">
          ‚ÑπÔ∏è Sua API Key ser√° armazenada localmente e de forma segura no seu navegador
        </p>
      </div>

      <div id="smoobuConnected" style="display: none;">
        <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
          <h4 style="margin-bottom: 8px; color: #166534;">‚úÖ Conectado com sucesso!</h4>
          <p style="color: #15803d; font-size: 14px;">Sua conta Smoobu est√° conectada e pronta para sincronizar.</p>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
          <div style="text-align: center; padding: 20px; background: #f9f9f9; border-radius: 8px;">
            <div style="font-size: 13px; color: #666; margin-bottom: 8px;">Apartamentos</div>
            <div id="smoobuApartments" style="font-size: 24px; font-weight: 700; color: #1a1a1a;">-</div>
          </div>
          <div style="text-align: center; padding: 20px; background: #f9f9f9; border-radius: 8px;">
            <div style="font-size: 13px; color: #666; margin-bottom: 8px;">√öltima Sincroniza√ß√£o</div>
            <div id="smoobuLastSync" style="font-size: 14px; font-weight: 600; color: #1a1a1a;">Nunca</div>
          </div>
        </div>

        <button class="btn btn-success" onclick="syncSmoobu()" style="width: 100%;">
          üîÑ Sincronizar Agora
        </button>
      </div>
    </div>

    <!-- Logs de sincroniza√ß√£o -->
    <div class="card">
      <h3 style="margin-bottom: 16px;">üìã Hist√≥rico de Sincroniza√ß√µes</h3>
      <div id="smoobuLogs" style="max-height: 400px; overflow-y: auto;">
        <p style="text-align: center; padding: 40px; color: #666;">Nenhuma sincroniza√ß√£o realizada ainda</p>
      </div>
    </div>
  </div>

  <!-- DESPESAS MENSAIS -->
  <div id="despesas" class="hidden">
    <div class="page-header">
      <h1>Despesas Mensais</h1>
      <p>Adicione despesas fixas ou vari√°veis antes de fechar o m√™s</p>
    </div>
    
    <div class="card" style="margin-bottom: 20px;">
      <h3 style="margin-bottom: 16px;">‚ûï Nova Despesa</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 12px; align-items: end;">
        <div>
          <label style="display: block; font-size: 13px; color: #666; margin-bottom: 6px;">Tipo de Despesa</label>
          <select id="despesaTipo" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            <option value="energia">Energia</option>
            <option value="condominio">Condom√≠nio</option>
            <option value="agua">√Ågua</option>
            <option value="internet">Internet</option>
            <option value="manutencao">Manuten√ß√£o</option>
            <option value="outros">Outros</option>
          </select>
        </div>
        <div>
          <label style="display: block; font-size: 13px; color: #666; margin-bottom: 6px;">Unidade</label>
          <select id="despesaUnidade" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            <option value="">Selecione...</option>
          </select>
        </div>
        <div>
          <label style="display: block; font-size: 13px; color: #666; margin-bottom: 6px;">Valor (R$)</label>
          <input type="number" id="despesaValor" placeholder="0,00" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
        </div>
        <div>
          <label style="display: block; font-size: 13px; color: #666; margin-bottom: 6px;">Descri√ß√£o</label>
          <input type="text" id="despesaDesc" placeholder="Opcional" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
        </div>
        <button class="btn btn-primary" onclick="addDespesa()" style="padding: 10px 20px;">‚ûï Adicionar</button>
      </div>
    </div>
    
    <div class="card">
      <h3 style="margin-bottom: 16px;">üí∏ Despesas do M√™s Atual</h3>
      <div id="despesasList"></div>
    </div>
  </div>

  <!-- INDICADORES -->
  <div id="indicadores" class="hidden">
    <div class="page-header">
      <h1>Indicadores</h1>
      <p>An√°lises e m√©tricas avan√ßadas</p>
    </div>
    
    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
      <select id="filtroAno" onchange="renderIndicadores()" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
        <option value="">Todos os anos</option>
      </select>
      <select id="filtroMes" onchange="renderIndicadores()" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
        <option value="">Todos os meses</option>
        <option value="01">Janeiro</option>
        <option value="02">Fevereiro</option>
        <option value="03">Mar√ßo</option>
        <option value="04">Abril</option>
        <option value="05">Maio</option>
        <option value="06">Junho</option>
        <option value="07">Julho</option>
        <option value="08">Agosto</option>
        <option value="09">Setembro</option>
        <option value="10">Outubro</option>
        <option value="11">Novembro</option>
        <option value="12">Dezembro</option>
      </select>
      <select id="filtroUnidade" onchange="renderIndicadores()" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
        <option value="">Todas as unidades</option>
      </select>
    </div>
    
    <div id="indicadoresContent"></div>
  </div>

  <!-- HIST√ìRICO -->
  <div id="historico" class="hidden">
    <div class="page-header">
      <h1>Hist√≥rico Mensal</h1>
      <p>Visualize os fechamentos mensais salvos</p>
    </div>
    
    <div style="display: flex; gap: 12px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
      <div id="historicoShortcuts" style="display: flex; gap: 8px; flex-wrap: wrap; flex: 1;"></div>
      <div style="display: flex; gap: 8px;">
        <button class="btn btn-outline" onclick="openWhatsAppConfig()">
          üì± Configurar WhatsApp
        </button>
      </div>
    </div>
    
    <div id="historicoList"></div>
    <div id="historicoEmpty" class="empty-state" style="display: none;">
      <div class="empty-state-icon">üìÖ</div>
      <h3>Nenhum fechamento salvo</h3>
      <p>Salve um fechamento mensal no Dashboard para visualizar aqui</p>
      <button class="btn btn-primary" onclick="showPage('dashboard'); document.querySelector('.menu a').classList.add('active');">üìä Ir para Dashboard</button>
    </div>
  </div>

  <!-- UPLOAD -->
  <div id="upload" class="hidden">
    <div class="page-header">
      <h1>Upload Smoobu (Excel)</h1>
      <p>Importe o arquivo Excel exportado do Smoobu</p>
    </div>
    <div class="card">
      <input type="file" id="excelFile" accept=".xlsx,.xls" style="margin-bottom: 16px;">
      <p style="font-size: 14px; color: #666; margin-bottom: 16px;">
        O arquivo deve conter as colunas: <b>Alojamento</b>, <b>Pre√ßo</b>, <b>Portal</b>
      </p>
      <button class="btn btn-primary" onclick="processExcel()">üì• Processar Arquivo</button>
      <p id="uploadStatus" style="margin-top: 16px; font-size: 14px;"></p>
    </div>
  </div>

</div>

<!-- MODAL CONFIG UNIDADE -->
<div class="modal" id="configModal">
  <div class="modal-content">
    <h3>Configura√ß√£o da Unidade</h3>

    <label>Unidade</label>
    <select id="cfgUnit"></select>

    <label>Propriet√°rio</label>
    <select id="cfgOwner">
      <option>Bandeira Beach House</option>
      <option>Williian</option>
      <option>Paulo</option>
      <option>Rafael</option>
    </select>

    <label>Comiss√£o administrador (%)</label>
    <input type="number" id="cfgAdm" step="0.01">

    <label>Tipo de limpeza</label>
    <select id="cfgCleanType">
      <option value="por">Por entrada</option>
      <option value="fixa">Fixa mensal</option>
    </select>

    <label>Valor da limpeza (R$)</label>
    <input type="number" id="cfgCleanValue" step="0.01">

    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeConfig()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveConfig()">Salvar</button>
    </div>
  </div>
</div>

<script>
const LIMPEZA_PADRAO = 55;
let unidades = {};
let extras = JSON.parse(localStorage.getItem("extras") || "{}");
let cfg = JSON.parse(localStorage.getItem("cfg") || "{}");
let despesas = JSON.parse(localStorage.getItem("despesas") || "[]");
let whatsappConfig = JSON.parse(localStorage.getItem("whatsappConfig") || "{}");
let smoobuConfig = JSON.parse(localStorage.getItem("smoobuConfig") || "{}");
let smoobuLogs = JSON.parse(localStorage.getItem("smoobuLogs") || "[]");
let barChart = null;
let pieChart = null;

// Inicializar m√™s atual
document.getElementById('monthSelect').value = new Date().toISOString().slice(0, 7);

// Verificar conex√£o Smoobu ao carregar
updateSmoobuStatus();

/* NAVEGA√á√ÉO */
function showPage(id, el) {
  document.querySelectorAll('.menu a').forEach(a => a.classList.remove('active'));
  if (el) el.classList.add('active');
  document.querySelectorAll('.main > div').forEach(d => d.classList.add('hidden'));
  const page = document.getElementById(id);
  if (page) {
    page.classList.remove('hidden');
    if (id === 'historico') renderHistorico();
    if (id === 'smoobu') updateSmoobuPage();
  }
}

function openUpload() {
  showPage('upload');
  document.querySelectorAll('.menu a').forEach(a => a.classList.remove('active'));
}

/* SMOOBU API INTEGRATION */
async function connectSmoobu() {
  const apiKey = document.getElementById('smoobuApiKey').value.trim();
  
  if (!apiKey) {
    alert('‚ùå Por favor, insira sua API Key');
    return;
  }
  
  try {
    // Testar conex√£o
    const response = await fetch('https://login.smoobu.com/api/apartments', {
      headers: {
        'Api-Key': apiKey,
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error('Falha na autentica√ß√£o');
    }
    
    const data = await response.json();
    
    // Salvar configura√ß√£o
    smoobuConfig = {
      apiKey: apiKey,
      connected: true,
      connectedAt: new Date().toISOString(),
      apartments: data.apartments || []
    };
    
    localStorage.setItem('smoobuConfig', JSON.stringify(smoobuConfig));
    
    addSmoobuLog('success', `Conectado com sucesso! ${data.apartments?.length || 0} apartamentos encontrados.`);
    
    updateSmoobuStatus();
    updateSmoobuPage();
    
    alert('‚úÖ Conectado com sucesso ao Smoobu!');
    
  } catch (error) {
    console.error('Erro ao conectar:', error);
    alert('‚ùå Erro ao conectar. Verifique sua API Key e tente novamente.');
    addSmoobuLog('error', `Falha na conex√£o: ${error.message}`);
  }
}

function disconnectSmoobu() {
  if (!confirm('Tem certeza que deseja desconectar do Smoobu?')) return;
  
  smoobuConfig = {};
  localStorage.setItem('smoobuConfig', JSON.stringify(smoobuConfig));
  
  updateSmoobuStatus();
  updateSmoobuPage();
  
  addSmoobuLog('info', 'Desconectado do Smoobu');
  alert('‚úÖ Desconectado com sucesso!');
}

async function syncSmoobu() {
  if (!smoobuConfig.apiKey) {
    alert('‚ùå Conecte sua conta Smoobu primeiro!');
    showPage('smoobu');
    document.querySelectorAll('.menu a')[4].classList.add('active');
    return;
  }
  
  const btn = document.getElementById('btnSync');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<span class="loading"></span> Sincronizando...';
  btn.disabled = true;
  
  try {
    const monthSelect = document.getElementById('monthSelect').value;
    const [year, month] = monthSelect.split('-');
    
    // Buscar reservas do m√™s
    const startDate = `${year}-${month}-01`;
    const endDate = new Date(year, month, 0).toISOString().slice(0, 10);
    
    const response = await fetch(`https://login.smoobu.com/api/reservations?arrivalFrom=${startDate}&arrivalTo=${endDate}`, {
      headers: {
        'Api-Key': smoobuConfig.apiKey,
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error('Erro ao buscar reservas');
    }
    
    const data = await response.json();
    const reservations = data.bookings || [];
    
    // Processar reservas
    processSmoobuReservations(reservations);
    
    // Salvar √∫ltima sincroniza√ß√£o
    smoobuConfig.lastSync = new Date().toISOString();
    localStorage.setItem('smoobuConfig', JSON.stringify(smoobuConfig));
    
    addSmoobuLog('success', `${reservations.length} reservas sincronizadas para ${monthSelect}`);
    
    updateSmoobuStatus();
    render();
    updateKPIs();
    updateCharts();
    
    alert(`‚úÖ Sincronizado com sucesso! ${reservations.length} reservas importadas.`);
    
  } catch (error) {
    console.error('Erro ao sincronizar:', error);
    alert('‚ùå Erro ao sincronizar. Verifique sua conex√£o e tente novamente.');
    addSmoobuLog('error', `Falha na sincroniza√ß√£o: ${error.message}`);
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}

function processSmoobuReservations(reservations) {
  unidades = {};
  
  reservations.forEach(booking => {
    const apartmentName = booking.apartment?.name || 'Desconhecido';
    const price = parseFloat(booking.price) || 0;
    const channel = (booking.channel?.name || '').toLowerCase();
    
    if (!unidades[apartmentName]) {
      unidades[apartmentName] = {reservas: 0, receita: 0, comissao: 0};
    }
    
    unidades[apartmentName].reservas++;
    unidades[apartmentName].receita += price;
    
    // Calcular comiss√µes baseadas no canal
    if (channel.includes('booking')) {
      unidades[apartmentName].comissao += price * 0.15;
    } else if (channel.includes('airbnb')) {
      unidades[apartmentName].comissao += price * 0.03;
    }
  });
}

function updateSmoobuStatus() {
  const isConnected = smoobuConfig.connected && smoobuConfig.apiKey;
  const statusBadge = document.getElementById('smoobuStatus');
  const statusPage = document.getElementById('smoobuStatusPage');
  
  if (isConnected) {
    statusBadge.className = 'status-badge status-connected';
    statusBadge.innerHTML = '‚úÖ Smoobu conectado';
    
    if (statusPage) {
      statusPage.className = 'status-badge status-connected';
      statusPage.innerHTML = '‚úÖ Conectado';
    }
  } else {
    statusBadge.className = 'status-badge status-disconnected';
    statusBadge.innerHTML = '‚ö†Ô∏è Smoobu desconectado';
    
    if (statusPage) {
      statusPage.className = 'status-badge status-disconnected';
      statusPage.innerHTML = '‚ö†Ô∏è Desconectado';
    }
  }
}

function updateSmoobuPage() {
  const isConnected = smoobuConfig.connected && smoobuConfig.apiKey;
  
  document.getElementById('smoobuConnect').style.display = isConnected ? 'none' : 'block';
  document.getElementById('smoobuConnected').style.display = isConnected ? 'block' : 'none';
  document.getElementById('btnDisconnect').style.display = isConnected ? 'block' : 'none';
  
  if (isConnected) {
    document.getElementById('smoobuApartments').textContent = smoobuConfig.apartments?.length || 0;
    
    if (smoobuConfig.lastSync) {
      const lastSync = new Date(smoobuConfig.lastSync);
      document.getElementById('smoobuLastSync').textContent = lastSync.toLocaleString('pt-BR');
    }
  }
  
  renderSmoobuLogs();
}

function addSmoobuLog(type, message) {
  const log = {
    type,
    message,
    timestamp: new Date().toISOString()
  };
  
  smoobuLogs.unshift(log);
  if (smoobuLogs.length > 50) smoobuLogs = smoobuLogs.slice(0, 50);
  
  localStorage.setItem('smoobuLogs', JSON.stringify(smoobuLogs));
  renderSmoobuLogs();
}

function renderSmoobuLogs() {
  const container = document.getElementById('smoobuLogs');
  
  if (smoobuLogs.length === 0) {
    container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">Nenhuma sincroniza√ß√£o realizada ainda</p>';
    return;
  }
  
  container.innerHTML = smoobuLogs.map(log => {
    const date = new Date(log.timestamp);
    const icon = log.type === 'success' ? '‚úÖ' : log.type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
    const color = log.type === 'success' ? '#166534' : log.type === 'error' ? '#991b1b' : '#666';
    
    return `
      <div style="padding: 12px; border-bottom: 1px solid #e5e5e5; display: flex; gap: 12px; align-items: start;">
        <span style="font-size: 18px;">${icon}</span>
        <div style="flex: 1;">
          <div style="font-weight: 500; color: ${color}; margin-bottom: 4px;">${log.message}</div>
          <div style="font-size: 12px; color: #999;">${date.toLocaleString('pt-BR')}</div>
        </div>
      </div>
    `;
  }).join('');
}

/* UPLOAD E PROCESSAMENTO */
function processExcel() {
  const file = document.getElementById('excelFile').files[0];
  if (!file) {
    alert('Selecione um arquivo Excel');
    return;
  }

  const reader = new FileReader();
  reader.onload = evt => {
    const data = new Uint8Array(evt.target.result);
    const wb = XLSX.read(data, {type: "array"});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet);
    processData(rows);
    document.getElementById("uploadStatus").innerHTML = 
      `‚úÖ Arquivo carregado com sucesso! ${rows.length} linhas processadas.`;
    
    setTimeout(() => {
      showPage('dashboard');
      document.querySelector('.menu a').classList.add('active');
    }, 1500);
  };
  reader.readAsArrayBuffer(file);
}

function processData(rows) {
  unidades = {};
  rows.forEach(r => {
    const apto = r["Alojamento"] || r["alojamento"];
    const preco = Number(r["Pre√ßo"] || r["Preco"] || r["preco"] || 0);
    const portal = String(r["Portal"] || r["portal"] || "").toLowerCase();
    
    if (!apto || !preco) return;

    if (!unidades[apto]) {
      unidades[apto] = {reservas: 0, receita: 0, comissao: 0};
    }

    unidades[apto].reservas++;
    unidades[apto].receita += preco;
    
    if (portal.includes("booking")) {
      unidades[apto].comissao += preco * 0.15;
    } else if (portal.includes("airbnb")) {
      unidades[apto].comissao += preco * 0.03;
    }
  });
  
  render();
  updateKPIs();
  updateCharts();
}

/* RENDERIZA√á√ÉO */
function render() {
  const container = document.getElementById("cards");
  const emptyState = document.getElementById("emptyState");
  
  if (Object.keys(unidades).length === 0) {
    container.innerHTML = "";
    emptyState.classList.remove('hidden');
    return;
  }
  
  emptyState.classList.add('hidden');
  container.innerHTML = "";

  Object.entries(unidades).forEach(([u, d]) => {
    const conf = cfg[u] || {};
    const owner = conf.owner || "Sem propriet√°rio";

    let limpeza = 0;
    if (conf.cleanType === "fixa") {
      limpeza = Number(conf.cleanValue || 0);
    } else {
      const v = conf.cleanValue || LIMPEZA_PADRAO;
      limpeza = d.reservas * v;
    }

    const adm = d.receita * (conf.adm || 0) / 100;
    const ext = extras[u] || 0;
    const lucro = d.receita - d.comissao - limpeza - adm - ext;

    container.innerHTML += `
      <div class="card">
        <h3>${u}</h3>
        <div class="owner">Propriet√°rio: ${owner}</div>
        <div class="row"><span>Reservas</span><b>${d.reservas}</b></div>
        <div class="row"><span>Receita</span><b>${formatCurrency(d.receita)}</b></div>
        <div class="row"><span>Comiss√£o portais</span><b class="negative">-${formatCurrency(d.comissao)}</b></div>
        <div class="row"><span>Comiss√£o administrador</span><b class="negative">-${formatCurrency(adm)}</b></div>
        <div class="row"><span>Limpeza</span><b class="negative">-${formatCurrency(limpeza)}</b></div>
        <div class="row"><span>Extras</span><b class="negative">-${formatCurrency(ext)}</b></div>
        <input class="extra" type="number" placeholder="Adicionar despesa extra (R$)"
          onchange="extras['${u}']=Number(this.value)||0;
                    localStorage.setItem('extras',JSON.stringify(extras));
                    render(); updateKPIs(); updateCharts();">
        <div class="lucro">Lucro: ${formatCurrency(lucro)}</div>
        <button class="btn btn-outline" style="width: 100%; margin-top: 12px;" 
          onclick="openConfigForUnit('${u}')">‚öôÔ∏è Configurar</button>
      </div>
    `;
  });
}

function formatCurrency(value) {
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL'
  }).format(value);
}

function updateKPIs() {
  let totalReceita = 0;
  let totalLucro = 0;
  let totalReservas = 0;

  Object.entries(unidades).forEach(([u, d]) => {
    const conf = cfg[u] || {};
    let limpeza = 0;
    
    if (conf.cleanType === "fixa") {
      limpeza = Number(conf.cleanValue || 0);
    } else {
      limpeza = d.reservas * (conf.cleanValue || LIMPEZA_PADRAO);
    }

    const adm = d.receita * (conf.adm || 0) / 100;
    const ext = extras[u] || 0;
    const lucro = d.receita - d.comissao - limpeza - adm - ext;

    totalReceita += d.receita;
    totalLucro += lucro;
    totalReservas += d.reservas;
  });

  document.getElementById('kpiReceita').textContent = formatCurrency(totalReceita);
  document.getElementById('kpiLucro').textContent = formatCurrency(totalLucro);
  document.getElementById('kpiReservas').textContent = totalReservas;
  document.getElementById('kpiUnidades').textContent = Object.keys(unidades).length;
}

function updateCharts() {
  const labels = [];
  const receitaData = [];
  const lucroData = [];

  Object.entries(unidades).forEach(([u, d]) => {
    const conf = cfg[u] || {};
    let limpeza = 0;
    
    if (conf.cleanType === "fixa") {
      limpeza = Number(conf.cleanValue || 0);
    } else {
      limpeza = d.reservas * (conf.cleanValue || LIMPEZA_PADRAO);
    }

    const adm = d.receita * (conf.adm || 0) / 100;
    const ext = extras[u] || 0;
    const lucro = d.receita - d.comissao - limpeza - adm - ext;

    labels.push(u);
    receitaData.push(d.receita);
    lucroData.push(lucro);
  });

  const barCtx = document.getElementById('barChart');
  if (barChart) barChart.destroy();
  
  barChart = new Chart(barCtx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Receita',
          data: receitaData,
          backgroundColor: 'rgba(74, 155, 142, 0.8)',
        },
        {
          label: 'Lucro',
          data: lucroData,
          backgroundColor: 'rgba(212, 184, 150, 0.8)',
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });

  const pieCtx = document.getElementById('pieChart');
  if (pieChart) pieChart.destroy();
  
  pieChart = new Chart(pieCtx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: receitaData,
        backgroundColor: [
          'rgba(74, 155, 142, 0.8)',
          'rgba(212, 184, 150, 0.8)',
          'rgba(74, 155, 142, 0.6)',
          'rgba(212, 184, 150, 0.6)',
          'rgba(74, 155, 142, 0.4)',
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
}

/* CONFIG MODAL */
function openConfigForUnit(unitName) {
  const sel = document.getElementById("cfgUnit");
  sel.innerHTML = "";
  Object.keys(unidades).forEach(u => {
    const opt = document.createElement('option');
    opt.value = u;
    opt.textContent = u;
    if (u === unitName) opt.selected = true;
    sel.appendChild(opt);
  });
  loadConfig();
  document.getElementById("configModal").classList.add('show');
}

function closeConfig() {
  document.getElementById("configModal").classList.remove('show');
}

function loadConfig() {
  const u = cfgUnit.value;
  const c = cfg[u] || {};
  cfgOwner.value = c.owner || "Bandeira Beach House";
  cfgAdm.value = c.adm || "";
  cfgCleanType.value = c.cleanType || "por";
  cfgCleanValue.value = c.cleanValue || "";
}

cfgUnit.onchange = loadConfig;

function saveConfig() {
  const u = cfgUnit.value;
  cfg[u] = {
    owner: cfgOwner.value,
    adm: Number(cfgAdm.value),
    cleanType: cfgCleanType.value,
    cleanValue: Number(cfgCleanValue.value)
  };
  localStorage.setItem("cfg", JSON.stringify(cfg));
  closeConfig();
  render();
  updateKPIs();
  updateCharts();
}

function saveMonth() {
  const month = document.getElementById('monthSelect').value;
  const data = {
    month: month,
    unidades: unidades,
    cfg: cfg,
    extras: extras,
    timestamp: new Date().toISOString()
  };
  
  const saved = JSON.parse(localStorage.getItem('historico') || '[]');
  const existing = saved.findIndex(s => s.month === month);
  
  if (existing >= 0) {
    saved[existing] = data;
  } else {
    saved.push(data);
  }
  
  localStorage.setItem('historico', JSON.stringify(saved));
  alert('‚úÖ Fechamento mensal salvo com sucesso!');
  renderHistorico();
}

function renderHistorico() {
  const saved = JSON.parse(localStorage.getItem('historico') || '[]');
  const container = document.getElementById('historicoList');
  const empty = document.getElementById('historicoEmpty');
  
  renderHistoricoShortcuts(saved);
  
  if (!saved || saved.length === 0) {
    if (container) container.innerHTML = '';
    if (empty) empty.style.display = 'block';
    return;
  }
  
  if (empty) empty.style.display = 'none';
  
  saved.sort((a, b) => b.month.localeCompare(a.month));
  
  if (!container) return;
  
  container.innerHTML = saved.map(item => {
    let totalReceita = 0;
    let totalLucro = 0;
    let totalReservas = 0;
    let totalComissoes = 0;
    let totalAdm = 0;
    let totalLimpeza = 0;
    let totalExtras = 0;
    
    const unitsHtml = Object.entries(item.unidades || {}).map(([u, d]) => {
      const conf = item.cfg[u] || {};
      let limpeza = 0;
      
      if (conf.cleanType === 'fixa') {
        limpeza = Number(conf.cleanValue || 0);
      } else {
        limpeza = d.reservas * (conf.cleanValue || LIMPEZA_PADRAO);
      }
      
      const adm = d.receita * (conf.adm || 0) / 100;
      const ext = (item.extras && item.extras[u]) || 0;
      const lucro = d.receita - d.comissao - limpeza - adm - ext;
      
      totalReceita += d.receita;
      totalComissoes += d.comissao;
      totalAdm += adm;
      totalLimpeza += limpeza;
      totalExtras += ext;
      totalLucro += lucro;
      totalReservas += d.reservas;
      
      return `
        <div class="historico-unit">
          <h4>${u}</h4>
          <div class="row"><span>Propriet√°rio</span><b>${conf.owner || 'N/A'}</b></div>
          <div class="row"><span>Reservas</span><b>${d.reservas}</b></div>
          <div class="row"><span>Receita</span><b>${formatCurrency(d.receita)}</b></div>
          <div class="row"><span>Comiss√£o portais</span><b class="negative">-${formatCurrency(d.comissao)}</b></div>
          <div class="row"><span>Comiss√£o admin</span><b class="negative">-${formatCurrency(adm)}</b></div>
          <div class="row"><span>Limpeza</span><b class="negative">-${formatCurrency(limpeza)}</b></div>
          <div class="row"><span>Extras</span><b class="negative">-${formatCurrency(ext)}</b></div>
          <div class="row"><span><strong>Lucro</strong></span><b style="color: #4a9b8e; font-size: 16px;"><strong>${formatCurrency(lucro)}</strong></b></div>
        </div>
      `;
    }).join('');
    
    const monthDate = new Date(item.month + '-01');
    const monthName = monthDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
    const saveDate = new Date(item.timestamp).toLocaleDateString('pt-BR', { 
      day: '2-digit', 
      month: '2-digit', 
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    return `
      <div class="historico-card">
        <div class="historico-header">
          <div>
            <div class="historico-title">${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</div>
            <div class="historico-date">Salvo em ${saveDate}</div>
          </div>
          <div class="historico-actions">
            <button class="btn btn-outline" onclick="sendWhatsApp('${item.month}')">üì± WhatsApp</button>
            <button class="btn btn-outline" onclick="loadMonth('${item.month}')">üì• Carregar</button>
            <button class="btn btn-outline" onclick="deleteMonth('${item.month}')" style="color: #dc2626;">üóëÔ∏è Excluir</button>
          </div>
        </div>
        
        <div class="historico-kpis">
          <div class="historico-kpi">
            <div class="historico-kpi-label">Reservas</div>
            <div class="historico-kpi-value">${totalReservas}</div>
          </div>
          <div class="historico-kpi">
            <div class="historico-kpi-label">Receita</div>
            <div class="historico-kpi-value">${formatCurrency(totalReceita)}</div>
          </div>
          <div class="historico-kpi">
            <div class="historico-kpi-label">Lucro L√≠quido</div>
            <div class="historico-kpi-value primary">${formatCurrency(totalLucro)}</div>
          </div>
        </div>
        
        <div class="historico-units">${unitsHtml}</div>
      </div>
    `;
  }).join('');
}

function renderHistoricoShortcuts(saved) {
  const container = document.getElementById('historicoShortcuts');
  
  if (!saved || saved.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  const sorted = [...saved].sort((a, b) => b.month.localeCompare(a.month));
  const recent = sorted.slice(0, 12);
  
  container.innerHTML = recent.map(item => {
    const date = new Date(item.month + '-01');
    const label = date.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
    return `<button class="btn btn-outline" onclick="loadMonth('${item.month}')" style="padding: 6px 12px; font-size: 13px;">${label}</button>`;
  }).join('');
}

function loadMonth(month) {
  const saved = JSON.parse(localStorage.getItem('historico') || '[]');
  const data = saved.find(s => s.month === month);
  
  if (!data) {
    alert('‚ùå Fechamento n√£o encontrado!');
    return;
  }
  
  unidades = data.unidades;
  cfg = data.cfg;
  extras = data.extras;
  
  document.getElementById('monthSelect').value = month;
  
  render();
  updateKPIs();
  updateCharts();
  
  showPage('dashboard');
  document.querySelectorAll('.menu a').forEach(a => a.classList.remove('active'));
  document.querySelector('.menu a').classList.add('active');
  
  alert('‚úÖ Fechamento carregado com sucesso!');
}

function deleteMonth(month) {
  if (!confirm('Tem certeza que deseja excluir este fechamento?')) return;
  
  const saved = JSON.parse(localStorage.getItem('historico') || '[]');
  const filtered = saved.filter(s => s.month !== month);
  
  localStorage.setItem('historico', JSON.stringify(filtered));
  renderHistorico();
  alert('‚úÖ Fechamento exclu√≠do com sucesso!');
}

/* DESPESAS */
function addDespesa() {
  const tipo = document.getElementById('despesaTipo').value;
  const unidade = document.getElementById('despesaUnidade').value;
  const valor = parseFloat(document.getElementById('despesaValor').value);
  const desc = document.getElementById('despesaDesc').value;
  
  if (!unidade) {
    alert('‚ùå Selecione uma unidade!');
    return;
  }
  
  if (!valor || valor <= 0) {
    alert('‚ùå Informe um valor v√°lido!');
    return;
  }
  
  const despesa = {
    id: Date.now(),
    tipo,
    unidade,
    valor,
    desc,
    data: new Date().toISOString()
  };
  
  despesas.push(despesa);
  localStorage.setItem('despesas', JSON.stringify(despesas));
  
  document.getElementById('despesaValor').value = '';
  document.getElementById('despesaDesc').value = '';
  
  renderDespesas();
  alert('‚úÖ Despesa adicionada com sucesso!');
}

function renderDespesas() {
  const container = document.getElementById('despesasList');
  const select = document.getElementById('despesaUnidade');
  
  const units = Object.keys(unidades);
  if (units.length > 0) {
    select.innerHTML = '<option value="">Selecione...</option>' + 
      units.map(u => `<option value="${u}">${u}</option>`).join('');
  }
  
  if (despesas.length === 0) {
    container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">Nenhuma despesa adicionada neste m√™s</p>';
    return;
  }
  
  const grouped = {};
  despesas.forEach(d => {
    if (!grouped[d.unidade]) grouped[d.unidade] = [];
    grouped[d.unidade].push(d);
  });
  
  container.innerHTML = Object.entries(grouped).map(([unidade, items]) => {
    const total = items.reduce((sum, d) => sum + d.valor, 0);
    const itemsHtml = items.map(d => `
      <div style="display: flex; justify-content: space-between; padding: 8px; background: #fafafa; border-radius: 4px; margin-bottom: 6px;">
        <div>
          <strong>${d.tipo}</strong>
          ${d.desc ? `<span style="color: #666; font-size: 13px;"> - ${d.desc}</span>` : ''}
          <div style="font-size: 12px; color: #999;">${new Date(d.data).toLocaleDateString('pt-BR')}</div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <strong style="color: #dc2626;">-${formatCurrency(d.valor)}</strong>
          <button onclick="removeDespesa(${d.id})" style="background: none; border: none; cursor: pointer; color: #dc2626; font-size: 18px;">√ó</button>
        </div>
      </div>
    `).join('');
    
    return `
      <div style="margin-bottom: 20px; padding: 16px; background: #f9f9f9; border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h4>${unidade}</h4>
          <strong style="color: #dc2626; font-size: 16px;">Total: -${formatCurrency(total)}</strong>
        </div>
        ${itemsHtml}
      </div>
    `;
  }).join('');
}

function removeDespesa(id) {
  if (!confirm('Deseja realmente excluir esta despesa?')) return;
  
  despesas = despesas.filter(d => d.id !== id);
  localStorage.setItem('despesas', JSON.stringify(despesas));
  renderDespesas();
}

/* WHATSAPP */
function openWhatsAppConfig() {
  const phone = prompt('Digite o n√∫mero do WhatsApp (com DDD, sem espa√ßos):', whatsappConfig.phone || '');
  
  if (phone === null) return;
  
  if (phone && !/^\d{10,11}$/.test(phone)) {
    alert('‚ùå N√∫mero inv√°lido! Use apenas n√∫meros (DDD + telefone).');
    return;
  }
  
  whatsappConfig.phone = phone;
  localStorage.setItem('whatsappConfig', JSON.stringify(whatsappConfig));
  alert('‚úÖ WhatsApp configurado com sucesso!');
}

function sendWhatsApp(month) {
  if (!whatsappConfig.phone) {
    alert('‚ùå Configure o WhatsApp primeiro!');
    openWhatsAppConfig();
    return;
  }
  
  const saved = JSON.parse(localStorage.getItem('historico') || '[]');
  const data = saved.find(s => s.month === month);
  
  if (!data) {
    alert('‚ùå Fechamento n√£o encontrado!');
    return;
  }
  
  let totalReceita = 0;
  let totalLucro = 0;
  let totalReservas = 0;
  
  const unitsText = Object.entries(data.unidades || {}).map(([u, d]) => {
    const conf = data.cfg[u] || {};
    let limpeza = 0;
    
    if (conf.cleanType === 'fixa') {
      limpeza = Number(conf.cleanValue || 0);
    } else {
      limpeza = d.reservas * (conf.cleanValue || LIMPEZA_PADRAO);
    }
    
    const adm = d.receita * (conf.adm || 0) / 100;
    const ext = (data.extras && data.extras[u]) || 0;
    const lucro = d.receita - d.comissao - limpeza - adm - ext;
    
    totalReceita += d.receita;
    totalLucro += lucro;
    totalReservas += d.reservas;
    
    return `*${u}* (${conf.owner || 'N/A'})\nReservas: ${d.reservas}\nReceita: ${formatCurrency(d.receita)}\nLucro: ${formatCurrency(lucro)}`;
  }).join('\n\n');
  
  const monthDate = new Date(month + '-01');
  const monthName = monthDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
  
  const message = `üè† *Bandeira Stay - ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}*\n\n` +
    `üìä *Resumo Geral*\n` +
    `Reservas: ${totalReservas}\n` +
    `Receita: ${formatCurrency(totalReceita)}\n` +
    `*Lucro L√≠quido: ${formatCurrency(totalLucro)}*\n\n` +
    `üè° *Detalhamento por Unidade*\n\n${unitsText}`;
  
  const url = `https://wa.me/55${whatsappConfig.phone}?text=${encodeURIComponent(message)}`;
  window.open(url, '_blank');
}

/* INDICADORES */
function renderIndicadores() {
  const saved = JSON.parse(localStorage.getItem('historico') || '[]');
  const container = document.getElementById('indicadoresContent');
  const filtroAno = document.getElementById('filtroAno').value;
  const filtroMes = document.getElementById('filtroMes').value;
  const filtroUnidade = document.getElementById('filtroUnidade').value;
  
  const anos = [...new Set(saved.map(s => s.month.split('-')[0]))].sort().reverse();
  const selectAno = document.getElementById('filtroAno');
  if (selectAno.options.length === 1) {
    selectAno.innerHTML = '<option value="">Todos os anos</option>' + 
      anos.map(a => `<option value="${a}">${a}</option>`).join('');
  }
  
  const unidades = new Set();
  saved.forEach(s => Object.keys(s.unidades || {}).forEach(u => unidades.add(u)));
  const selectUnidade = document.getElementById('filtroUnidade');
  if (selectUnidade.options.length === 1) {
    selectUnidade.innerHTML = '<option value="">Todas as unidades</option>' + 
      [...unidades].sort().map(u => `<option value="${u}">${u}</option>`).join('');
  }
  
  let filtered = saved;
  if (filtroAno) filtered = filtered.filter(s => s.month.startsWith(filtroAno));
  if (filtroMes) filtered = filtered.filter(s => s.month.endsWith('-' + filtroMes));
  
  if (filtered.length === 0) {
    container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">Nenhum dado dispon√≠vel para os filtros selecionados</p>';
    return;
  }
  
  let totalReservas = 0;
  let totalReceita = 0;
  const unidadesData = {};
  
  filtered.forEach(item => {
    Object.entries(item.unidades || {}).forEach(([u, d]) => {
      if (filtroUnidade && u !== filtroUnidade) return;
      
      totalReservas += d.reservas;
      totalReceita += d.receita;
      
      if (!unidadesData[u]) {
        unidadesData[u] = { reservas: 0, receita: 0 };
      }
      unidadesData[u].reservas += d.reservas;
      unidadesData[u].receita += d.receita;
    });
  });
  
  const ticketMedio = totalReservas > 0 ? totalReceita / totalReservas : 0;
  
  const kpisHtml = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
      <div class="card" style="text-align: center;">
        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">Ticket M√©dio</div>
        <div style="font-size: 28px; font-weight: 700; color: #4a9b8e;">${formatCurrency(ticketMedio)}</div>
      </div>
      <div class="card" style="text-align: center;">
        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">Total de Reservas</div>
        <div style="font-size: 28px; font-weight: 700; color: #1a1a1a;">${totalReservas}</div>
      </div>
      <div class="card" style="text-align: center;">
        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">Receita Total</div>
        <div style="font-size: 28px; font-weight: 700; color: #1a1a1a;">${formatCurrency(totalReceita)}</div>
      </div>
    </div>
  `;
  
  const unidadesHtml = `
    <div class="card">
      <h3 style="margin-bottom: 16px;">üè° Faturamento por Unidade</h3>
      <div style="display: grid; gap: 12px;">
        ${Object.entries(unidadesData).sort((a, b) => b[1].receita - a[1].receita).map(([u, d]) => `
          <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9f9f9; border-radius: 6px;">
            <div>
              <strong>${u}</strong>
              <div style="font-size: 13px; color: #666;">${d.reservas} reservas</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 18px; font-weight: 600; color: #4a9b8e;">${formatCurrency(d.receita)}</div>
              <div style="font-size: 13px; color: #666;">Ticket: ${formatCurrency(d.receita / d.reservas)}</div>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
  
  container.innerHTML = kpisHtml + unidadesHtml;
}

// Inicializar
render();
updateKPIs();
renderDespesas();
renderIndicadores();
</script>

</body>
</html>
